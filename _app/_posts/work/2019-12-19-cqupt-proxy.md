---
layout: post
title: CQUPT Reverse Proxy
category: work
permalink: work/cqupt-rproxy/
tags: works_community
scheme-text: "#3b1599"
scheme-link: "#ff3f00"
scheme-hover: "#ff3f00"
scheme-code: "#d6642a"
---

To make our school's internal resources accessible from the internet, I built a reverse proxy to expose everything behind our firewall to the internet.

> **Disclaimer**: This is an experimental project and everything is protected via Cloudflare Access with Origin Pull to ensure that only me and the people I authorized can access the endpoint.

![Screenshot](https://lwqh4t3.yoooooooo.tk/images/d1efbd7d30ee3ed76c14986af25f3499.png)
{: .browser}

## How to use it?
- **Domain Available:** Replace `cqupt.edu.cn` with `endpoint.domain`[^1] in the domain part of any URL.
- **IP Only:** Prepend IP address in front of `.endpoint.domain`.

e.g.
- If you want to visit `jwzx.cqupt.edu.cn`, just type `jwzx.endpoint.domain`
- Visit `127.20.0.1.endpoint.domain` instead of `127.20.0.1`

<details>
  <summary><b>Advanced Notices</b></summary>
  <ol>
    <li>Some destination server requires an TLS connection, and <code>*.secure.endpoint.domain</code> is aimed to do that. Otherwise, <code>*.endpoint.domain</code> will initiate a plain HTTP request to the destination.</li>
    <li>Considering there will be many direct IP forwards, and there is no need to acquire a certificate for them. Thus, any domain access like <code>jwzx.endpoint.domain</code> is provided with a valid wildcard certificate, while IP accesses are not.</li>
    <li>Destinations with unusual port(other than 80 and 443) are not supported and their link will not be overridden.</li>
  </ol>
</details>


## Under the hood
I used a Raspberry Pi 4 as the gateway benefited by its gigabit ethernet controller.

{: .largetype}
[NGINX Configuration &#x27A1;&#xfe0e;](https://colab.ifengge.cn/snippets/22)

### Override redirects
Of domains ending with `cqupt.edu.cn`
```nginx
proxy_redirect 		~^http://cqupt.edu.cn/(.*) https://endpoint.domain/$1;
proxy_redirect 		~^http://(.*).cqupt.edu.cn/(.*) https://$1.endpoint.domain/$2;
proxy_redirect		~^https://(.*).cqupt.edu.cn/(.*) https://$1.secure.endpoint.domain/$2;
```

Of IPs
```nginx
proxy_redirect		~^http://([0-9.]+)/(.*) http://$1.endpoint.domain/$2;
proxy_redirect		~^https://([0-9.]+)/(.*) http://$1.secure.endpoint.domain/$2;
```

### Override links on pages.  

`nginx_substitutions_filter` is an enhanced `sub_filter` module that allows multiple regexes to replace concurrently.  
Check out [Substitutions | NGINX](https://www.nginx.com/resources/wiki/modules/substitutions/) to find out more.

```nginx
subs_filter		'http://cqupt.edu.cn' https://endpoint.domain gir;
subs_filter		'http://(.*).cqupt.edu.cn' https://$1.endpoint.domain gir;
subs_filter		'https://(.*).cqupt.edu.cn' https://$1.secure.endpoint.domain gir;
subs_filter		'http://([0-9.]+)' http://$1.endpoint.domain gir;
subs_filter		'https://([0-9.]+)' http://$1.secure.endpoint.domain gir;
```
There is no need to match exact IPs since I configured a firewall to prevent malicious requests.

Use the following statement to resolve our internal domains from our internal DNS servers.
```nginx
resolver [ns1.ip] [ns2.ip] valid=3600s;
```

Then configure `iptables` to filter invalid requests.  
```shell
# Generated by xtables-save v1.8.3 on Thu Dec 19 03:26:35 2019
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A OUTPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A OUTPUT -d [network/mask] -p tcp -m owner --uid-owner 33 -j ACCEPT
...
-A OUTPUT -d [ns1.ip] -p udp -m owner --uid-owner 33 -j ACCEPT
-A OUTPUT -d [ns2.ip] -p udp -m owner --uid-owner 33 -j ACCEPT
-A OUTPUT -m owner --uid-owner 33 -j REJECT --reject-with icmp-port-unreachable
COMMIT
# Completed on Thu Dec 19 03:26:35 2019
```

[^1]: `endpoint.domain` denotes the domain name of the endpoint just in this article. Remember to replace it in the real world.  