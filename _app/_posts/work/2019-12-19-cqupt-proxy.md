---
layout: post
title: CQUPT Reverse Proxy
category: work
permalink: work/cqupt-rproxy/
tags: works_commercial
---

To make our school's internal resources accessible from the internet, I built a reverse proxy to expose everything behind our firewall to the internet.

> **Disclaimer**: Everything is protected via Cloudflare Access and Origin Pull is enabled to ensure that only me and the people I authorized can access the endpoint.

I used a Raspberry Pi 4 as our gateway benefited by its gigabit LAN controller.

{: .largetype}
[NGINX Configuration](https://colab.ifengge.cn/snippets/22)

## How to use it?
- **Domain is Provided:** Replace `cqupt.edu.cn` with `sixsixsix.ml` in the domain part of any URL.
- **IP Only:** Prepend IP address in front of `.sixsixsix.ml`.

e.g:
- If you want to visit `jwzx.cqupt.edu.cn`, just type `jwzx.sixsixsix.ml`
- Visit `127.20.0.1.sixsixsix.ml` instead of `127.20.0.1`

**Notice:**
1. Some destination server requires an SSL connection, and `*.ssl.sixsixsix.ml` is aim to do that. Otherwise, `*.sixsixsix.ml` will initiate a plain HTTP request to the destination.  
2. Considering there will be many direct IP forwards, Cloudflare has been configured to allow both HTTP and HTTPS traffic from users. Thus, any domain access like `jwzx.sixsixsix.ml` is provided with a valid SSL certificate, while IP accesses are not.
3. Destinations with unusual port(other than 80 and 443) are not supported and its link will not be overridden.

## Explanation

To override redirects of domain names with `cqupt.edu.cn`
```nginx
proxy_redirect 		~^http://(.*).cqupt.edu.cn/(.*) https://$1.sixsixsix.ml/$2;
proxy_redirect		~^https://(.*).cqupt.edu.cn/(.*) https://$1.ssl.sixsixsix.ml/$2;
```

And override direct IP redirects
```nginx
proxy_redirect		~^http://([0-9.]+)/(.*) http://$1.sixsixsix.ml/$2;
proxy_redirect		~^https://([0-9.]+)/(.*) http://$1.ssl.sixsixsix.ml/$2;
```

Also, I have to override every link on pages.
`nginx_substitutions_filter` is a enhanced `sub_filter` that allows regex replaces concurrently.  
Check out [Substitutions | NGINX](https://www.nginx.com/resources/wiki/modules/substitutions/) to find out more.

```nginx
subs_filter		'cqupt.edu.cn' sixsixsix.ml;
subs_filter		'http://([0-9.]+)/(.*)' http://$1.sixsixsix.ml/$2 gir;
subs_filter		'https://([0-9.]+)/(.*)' http://$1.ssl.sixsixsix.ml/$2 gir;
```
There is no need to match exact IPs since I configured a firewall to prevent malicious requests.

Use the following statement to resolve our internal domains from our internal DNS servers.
```nginx
resolver 202.202.32.33 202.202.32.34 valid=3600s;
```

Than configure `iptables` to filter legitimate requests.  
```iptables
# Generated by xtables-save v1.8.3 on Thu Dec 19 03:26:35 2019
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A OUTPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A OUTPUT -d 202.202.32.0/20 -p tcp -m owner --uid-owner 33 -j ACCEPT
-A OUTPUT -d 211.83.208.0/20 -p tcp -m owner --uid-owner 33 -j ACCEPT
-A OUTPUT -d 172.20.0.0/22 -p tcp -m owner --uid-owner 33 -j ACCEPT
-A OUTPUT -d 202.202.32.33/32 -p udp -m owner --uid-owner 33 -j ACCEPT
-A OUTPUT -d 202.202.32.34/32 -p udp -m owner --uid-owner 33 -j ACCEPT
-A OUTPUT -p udp -m owner --uid-owner 33 -j REJECT --reject-with icmp-port-unreachable
-A OUTPUT -p tcp -m owner --uid-owner 33 -j REJECT --reject-with icmp-port-unreachable
COMMIT
# Completed on Thu Dec 19 03:26:35 2019
```